<!DOCTYPE html>
<html lang="en">
  <head>

    <meta charset="utf-8">
    <title>transpile php to javascript</title>
    <meta name="description" content="Some ideas on how to build a php to javascript transpiler  I spend a good part of my work time in front of php or javascript code, so i wonder what will it be to compile php to javascript (in a browser context only). All of this is not tested it is just o...">
    <meta name="author"      content="antoine">
    <meta name="keywords"    content="php, javascript">
    <meta name="viewport"    content="width=device-width, initial-scale=1.0">
    <link rel="icon"      href="/favicon.ico">
    <link rel="canonical" href="http://antoineB.github.io/blog/2015/08/29/transpile-php-to-javascript/">
    <link rel="next" href="/blog/2015/07/06/mapping-data-from-sql-result-to-struct/">
    <link rel="prev" href="/blog/2016/01/09/exploring-typecheking-sql-query-in-typed-racket/">
    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/css/pygments.css">
    <!-- <link rel="stylesheet" type="text/css" href="/css/scribble.css"> -->
    <link rel="stylesheet" type="text/css" href="/css/custom.css">
    <!-- Feeds -->
    <link ref="alternate" type="application/atom+xml"
          href="/feeds/all.atom.xml" title="Atom Feed">
    <link ref="alternate" type="application/rss+xml"
          href="/feeds/all.rss.xml" title="RSS Feed">
  </head>
  <body>
    <!-- A standard Twitter Bootstrap nav bar -->
    <header class="navbar navbar-default navbar-inverse"
            role="banner">
      <div class="container">
        <div class="navbar-header">
          <button type="button"
                  class="navbar-toggle"
                  data-toggle="collapse"
                  data-target=".our-nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a href="/index.html" class="navbar-brand">antoineB's blog</a>
        </div>
        <div class="collapse navbar-collapse our-nav-collapse"
             role="navigation">
          <ul class="nav navbar-nav">

            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                Tags <b class="caret"></b></a>
              <ul class="dropdown-menu">
                <li><a href="/index.html">All Posts</a></li>

<li><a href="/tags/javascript.html">javascript</a></li>

<li><a href="/tags/language.html">language</a></li>

<li><a href="/tags/php.html">php</a></li>

<li><a href="/tags/racket.html">racket</a></li>
              </ul>
            </li>
            <li>
              <a href="/About.html">About</a>
            </li> 
            <li><a href="/feeds/all.atom.xml">Atom</a></li>
            <li><a href="/feeds/all.rss.xml">RSS</a></li>
          </ul>
        </div>
      </div>
    </header>
    <div class="container">
      <div class="row">

        <!-- Main column -->
        <div id="content" class="col-md-10">





          <article class="hentry">
  <header>
    <h1><span class="entry-title">transpile php to javascript</span> <small>
<time datetime="2015-08-29" pubdate="true">2015-08-29</time></small></h1>
  </header>
   <div class="entry-content">

<p class="lead">Some ideas on how to build a php to javascript transpiler</p>

<br />

<p>I spend a good part of my work time in front of php or javascript code, so i wonder what will it be to compile php to javascript (in a browser context only). All of this is not tested it is just out of my head, i should have looked up how other have come up with problems like <code>yield</code> but this would kill all interest.</p>
<!-- more-->

<p>Just some specifications of the top level definition that will be used through all the post:</p>

<div class="brush: javascript">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7
8</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="c1">// php functions (indexed by full qualified name)</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">PHPFunction</span> <span class="o">=</span> <span class="p">{};</span>
<span class="c1">// constructors as js function</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">PHPConstructor</span> <span class="o">=</span> <span class="p">{};</span>
<span class="c1">// all the class indexed by full qualified name</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">PHPClass</span> <span class="o">=</span> <span class="p">{};</span>
<span class="c1">// all the rest of the stuff, type constructor, type cast function, etc...</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">PHP</span> <span class="o">=</span> <span class="p">{};</span>
</pre></div>
</td></tr></tbody></table>
</div>

<h1 id="types">Types</h1>

<p>PHP type to javascript</p>

<ol>
 <li>string -&gt; js string</li>
 <li>float -&gt; a new class PHP.Float</li>
 <li>integer -&gt; js number</li>
 <li>bool -&gt; bool</li>
 <li>null -&gt; null</li>
 <li>undefined -&gt; undefined</li>
 <li>unassigned -&gt; a singleton of a class PHP.UnAssigned</li>
 <li>array -&gt; a new class PHP.Array</li>
 <li>object -&gt; a javascript object instance of PHP.Object</li></ol>

<p>There is no much thought to put into those choices maybe a wiser will try to have the maximum matching behavior between php <code>==</code>, <code>===</code> and js counter parts or other strategies to reduce the overhead of type checking.</p>

<p>The array in PHP is not just an array as you know so it can&rsquo;t be mapped directly to the vanilla js Array class. For now the easy way is to define a specific class to handle all the case (hash table, local index change etc&hellip;).</p>

<p>Continuing with the number it&rsquo;s necessary to introduce at least one new class to distinguish from Number the integer and the float.</p>

<p>Giving us something like:</p>

<div class="brush: javascript">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="nx">PHP</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">UnAssigned</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{};</span>
    <span class="kd">var</span> <span class="nx">UNASSIGNED</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UnAssigned</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">Float</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span> <span class="p">};</span>
    <span class="kd">var</span> <span class="nb">Array</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{};</span>
    <span class="kd">var</span> <span class="nb">Object</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{};</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">UNASSIGNED</span><span class="o">:</span> <span class="nx">UNASSIGNED</span><span class="p">,</span>
        <span class="nx">gettype</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">obj</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="s1">&#39;string&#39;</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;number&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="s1">&#39;integer&#39;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;boolean&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="s1">&#39;boolean&#39;</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="s1">&#39;array&#39;</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">Float</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="s1">&#39;double&#39;</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="k">instanceof</span> <span class="nb">Object</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="s1">&#39;object&#39;</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">obj</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">obj</span> <span class="o">===</span> <span class="nx">UNASSIGNED</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">String</span><span class="p">(</span><span class="s1">&#39;hope it never happen&#39;</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="nx">js_to_php</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="k">instanceof</span> <span class="nb">window</span><span class="p">.</span><span class="nb">Object</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="k">instanceof</span> <span class="nb">window</span><span class="p">.</span><span class="nb">String</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="k">instanceof</span> <span class="nb">window</span><span class="p">.</span><span class="nb">Array</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="k">new</span> <span class="nx">PHP</span><span class="p">.</span><span class="nb">Array</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="k">instanceof</span> <span class="nb">window</span><span class="p">.</span><span class="nb">Number</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nb">Number</span><span class="p">.</span><span class="nx">isInteger</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">return</span> <span class="k">new</span> <span class="nx">Float</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">PHP</span><span class="p">.</span><span class="nb">Object</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">obj</span> <span class="o">==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">obj</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;number&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nb">Number</span><span class="p">.</span><span class="nx">isInteger</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="k">new</span> <span class="nb">window</span><span class="p">.</span><span class="nb">Number</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="k">new</span> <span class="nx">Float</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">new</span> <span class="nb">window</span><span class="p">.</span><span class="nb">String</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;boolean&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">String</span><span class="p">(</span><span class="s1">&#39;hope it never happen&#39;</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="c1">// return a friendly datastructure from the point of view of javascript</span>
        <span class="nx">php_to_js</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">Float</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">Float</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="o">===</span> <span class="nx">UNASSIGNED</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">undefined</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">PHP</span><span class="p">.</span><span class="nb">Array</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// convert hash table into a json</span>
                <span class="c1">// a window.Array otherwise</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">PHP</span><span class="p">.</span><span class="nb">Object</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// return a json with public property and classname</span>
            <span class="p">}</span>
            <span class="c1">// string, int, null, undefined, bool, array</span>
            <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Maybe using the vanilla Array to treat the case where the array is actually an array indexed by ℕ⁰ with internal array pointer to 0 and expect a minor speedup.</p>

<div class="brush: javascript">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="kd">var</span> <span class="nx">PHPArray</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// init</span>
<span class="p">};</span>

<span class="nx">PHPArray</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span>
</pre></div>
</td></tr></tbody></table>
</div>

<h2 id="casting">Casting</h2>

<p>This should be carefully done according to the php <a href="http://php.net/manual/en/types.comparisons.php">docs</a>, the <code>(bool)</code> operator as an example:</p>

<div class="brush: javascript">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="nx">PHP</span><span class="p">.</span><span class="nx">cast_bool</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span> <span class="o">||</span> <span class="nx">obj</span> <span class="o">===</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">UNASSIGNED</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">PHP</span><span class="p">.</span><span class="nb">Array</span> <span class="o">&amp;&amp;</span> <span class="nx">PHP</span><span class="p">.</span><span class="nx">empty</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</td></tr></tbody></table>
</div>

<h1 id="mapping-variable-name">Mapping variable name</h1>

<p>The mapping between php and javascript of variable could be direct for instance if you declare a <code>$abc = 12</code> the js will be <code>var abc = Number(12)</code>.</p>

<p>But there is two exception <code>get_defined_vars()</code> and <code>extract()</code> to please them both its necessary to use a js object to get track of variables and populate them directly.</p>

<div class="brush: php">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6
7
8</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="cp">&lt;?php</span>

<span class="k">function</span> <span class="nf">abc</span><span class="p">()</span> <span class="p">{</span>
  <span class="nv">$a</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
  <span class="nb">extract</span><span class="p">([</span><span class="s1">&#39;b&#39;</span> <span class="o">=&gt;</span> <span class="mi">12</span><span class="p">]);</span>
  <span class="nb">get_defined_vars</span><span class="p">();</span>
  <span class="k">return</span> <span class="nx">someFun</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></tbody></table>
</div>

<div class="brush: javascript">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="nx">PHPFunction</span><span class="p">.</span><span class="nx">abc</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="nx">PHP</span><span class="p">.</span><span class="nx">states</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">state</span><span class="p">);</span>
  <span class="nx">state</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
  <span class="c1">// extract and get_defined_vars will lookup into PHP.states[PHP.states.length - 1]</span>
  <span class="nx">PHPFunction</span><span class="p">.</span><span class="nx">extract</span><span class="p">(</span><span class="nx">PHP</span><span class="p">.</span><span class="nx">array</span><span class="p">({</span><span class="s1">&#39;b&#39;</span> <span class="o">=&gt;</span> <span class="mi">12</span><span class="p">});</span>
  <span class="nx">PHPFunction</span><span class="p">.</span><span class="nx">get_defined_vars</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">PHPFunction</span><span class="p">.</span><span class="nx">someFun</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">a</span><span class="p">);</span>
  <span class="nx">PHP</span><span class="p">.</span><span class="nx">states</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
  <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The <code>PHP.states[0]</code> correspond to the globals variables. <code>PHP.states</code> is necessary because <code>get_defined_vars</code> and <code>extract</code> could be call dynamicaly and will always be able to reference the states they relate two with <code>PHP.states[PHP.states.length &ndash; 1]</code>.</p>

<p>For the rest of the code example i will use a direct mapping for readability.</p>

<h2 id="optimization">optimization</h2>

<p>If it can be proved that the current function code didn&rsquo;t call <code>extract</code> nor <code>get_defined_vars</code> then a direct mapping could be used instead.</p>

<p><code>PHP.states[PHP.states.length &ndash; 1]</code> may be slower than <code>PHP.states[0]</code> so the latter convention sould be used where <code>0</code> denote the current state and <code>PHP.states[PHP.states.length &ndash; 1]</code> the globals.</p>

<h1 id="class">Class</h1>

<p>A class like:</p>

<div class="brush: php">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">Abc</span> <span class="k">interface</span> <span class="nx">A</span><span class="p">,</span> <span class="nx">B</span> <span class="k">extends</span> <span class="nx">Edf</span> <span class="p">{</span>
    <span class="k">public</span> <span class="nv">$publicProp</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$privateProp</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$protectedProp</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__constructor</span><span class="p">(</span><span class="nv">$abc</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">private</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">publicMeth</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>
    <span class="k">private</span> <span class="k">function</span> <span class="nf">privateMeth</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="nf">protectedMeth</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Abc</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Translate to:</p>

<div class="brush: javascript">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="nx">PHPClass</span><span class="p">.</span><span class="nx">Abc</span> <span class="o">=</span> <span class="p">{</span>
    <span class="kr">interface</span><span class="o">:</span> <span class="p">[</span><span class="nx">PHPClass</span><span class="p">.</span><span class="nx">A</span><span class="p">,</span> <span class="nx">PHPCLass</span><span class="p">.</span><span class="nx">B</span><span class="p">],</span>
    <span class="kr">extends</span> <span class="nx">PHPClass</span><span class="p">.</span><span class="nx">Edf</span><span class="p">,</span>
    <span class="nx">private_method</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">privateMeth</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{}</span>
    <span class="p">},</span>
    <span class="nx">public_method</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">publicMeth</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{}</span>
    <span class="p">},</span>
    <span class="nx">protected_method</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">protectedMeth</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{}</span>
    <span class="p">},</span>
    <span class="nx">destruct</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">statics</span><span class="o">:</span> <span class="p">{},</span>
    <span class="nx">consts</span><span class="o">:</span> <span class="p">{},</span>
    <span class="nx">doc_comments</span><span class="o">:</span> <span class="p">{},</span>
    <span class="nx">invoke</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">__call</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">__set</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">__get</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="c1">// other magic method</span>
<span class="p">};</span>

<span class="nx">PHPConstructorBasic</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

<span class="nx">PHPConstructor</span><span class="p">.</span><span class="nx">Abc</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="kr">public</span><span class="p">.</span><span class="nx">publicProp</span> <span class="o">=</span> <span class="nx">PHP</span><span class="p">.</span><span class="nx">UNASSIGNED</span><span class="p">;</span> <span class="c1">// singleton</span>
    <span class="k">this</span><span class="p">.</span><span class="kr">protected</span><span class="p">.</span><span class="nx">protectedProp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="kr">private</span><span class="p">.</span><span class="nx">privateProp</span> <span class="o">=</span> <span class="nx">PHP</span><span class="p">.</span><span class="nx">UNASSIGNED</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">meta</span> <span class="o">=</span> <span class="nx">PHPClass</span><span class="p">.</span><span class="nx">Abc</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="kr">extends</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="nx">PHPConstructorBasic</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="kr">extends</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PHPConstructor</span><span class="p">.</span><span class="nx">Edf</span><span class="p">();</span>
    <span class="nx">PHPConstructorBasic</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

     <span class="k">if</span> <span class="p">(</span><span class="nx">PHPConstructorBasic</span> <span class="o">!==</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">abc</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="nx">PHP</span><span class="p">.</span><span class="nx">object_assign_property</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="s1">&#39;privateProp&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="nx">PHPConstructor</span><span class="p">.</span><span class="nx">Abc</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">PHPConstructor</span><span class="p">.</span><span class="nx">Edf</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span>

<span class="nx">PHPConstructor</span><span class="p">.</span><span class="nx">Edf</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">PHP</span><span class="p">.</span><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PHPConstructor</span><span class="p">.</span><span class="nx">Abc</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>So a php class is divided into two parts the part that contain the methods definitions, interfaces and the like. Another part wich is the constructor of an instance which contain the properties, the class which is the instance of (with meta) and its parent instance, the scope of property is needed to be done explicitly by lack of scope in javascript.</p>

<p>The constructor is composed of two parts the first that create the properties, assign their default value and call the save part of the constructor on the parent. The second is the user defined <code>__constructor</code> code. The parent constructor should be call explicitly in php so that why there is the variable PHPConstructorBasic.</p>

<p>Because i didn&rsquo;t use the javascript inheritance i need to wrap every use of <code>-&gt;</code> with a function. The fact i put <code>this</code> twice is not a mistake it&rsquo;s the current instance, it&rsquo;s seems silly in that example, but usefull when you do <code>$someVar = $this; $someVar-&gt;privateThing</code>. And then simulate the inheritance in the code in object_assign_property something like:</p>

<div class="brush: javascript">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="kd">var</span> <span class="nx">object_assign_property</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">assign</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">propertyName</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="kr">public</span><span class="p">[</span><span class="nx">propertyName</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">instance</span><span class="p">.</span><span class="kr">public</span><span class="p">[</span><span class="nx">propertyName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="kr">protected</span><span class="p">[</span><span class="nx">propertyName</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">instance</span><span class="p">.</span><span class="kr">protected</span><span class="p">[</span><span class="nx">propertyName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="kr">private</span><span class="p">[</span><span class="nx">propertyName</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">instance</span><span class="p">.</span><span class="kr">private</span><span class="p">[</span><span class="nx">propertyName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="kr">extends</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;no property &#39;</span> <span class="o">+</span> <span class="nx">propertyName</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">assign</span><span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="kr">extends</span><span class="p">,</span> <span class="nx">propertyName</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">assignPublic</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">propertyName</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="kr">public</span><span class="p">[</span><span class="nx">propertyName</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="kr">extends</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">assignPublic</span><span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="kr">extends</span><span class="p">,</span> <span class="nx">propertyName</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;no property &#39;</span> <span class="o">+</span> <span class="nx">propertyName</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">instance</span><span class="p">.</span><span class="kr">public</span><span class="p">[</span><span class="nx">propertyName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">instance</span><span class="p">,</span> <span class="nx">propertyName</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">context</span> <span class="o">==</span> <span class="nx">instance</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">assign</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">propertyName</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">assignPublic</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">propertyName</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>
    <span class="p">})();</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>And method call:</p>

<div class="brush: javascript">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="kd">var</span> <span class="nx">object_method_call</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">callMeth</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="kr">public</span><span class="p">[</span><span class="nx">methodName</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="kr">public</span><span class="p">[</span><span class="nx">methodName</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="kr">protected</span><span class="p">[</span><span class="nx">methodName</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="kr">protected</span><span class="p">[</span><span class="nx">methodName</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="kr">private</span><span class="p">[</span><span class="nx">methodName</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="kr">private</span><span class="p">[</span><span class="nx">methodName</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="kr">extends</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;no method &#39;</span> <span class="o">+</span> <span class="nx">methodName</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">callMeth</span><span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="kr">extends</span><span class="p">,</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">callMethPublic</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="kr">public</span><span class="p">[</span><span class="nx">methodName</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="kr">extends</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">callMethPublic</span><span class="p">(</span><span class="nx">instance</span><span class="p">.</span><span class="kr">extends</span><span class="p">,</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;no method &#39;</span> <span class="o">+</span> <span class="nx">methodName</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">instance</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="kr">public</span><span class="p">[</span><span class="nx">methodName</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">instance</span><span class="p">,</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">context</span> <span class="o">==</span> <span class="nx">instance</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">callMeth</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">callMethPublic</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">methodName</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>
    <span class="p">})();</span>
</pre></div>
</td></tr></tbody></table>
</div>

<h2 id="magic-method">Magic method</h2>

<p>There is nothing to say, because every object access is wrap into a function the logic for magic method (<code>__get</code>, <code>__set</code>, <code>__call</code>) could be added here.</p>

<p>For the rest the logic happen in other function.</p>

<h2 id="type-hinting">Type hinting</h2>

<p>Just add the check where relevant.</p>

<h2 id="self-static-and-parent">Self, static and parent</h2>

<p>Assume in class Abc, then:</p>

<ol>
 <li><code>self</code> translate to <code>PHPClass.Abc</code></li>
 <li><code>parent</code> translate to <code>PHPClass.Abc.extend</code></li>
 <li><code>static</code> translate to <code>this.meta</code></li></ol>

<h2 id="class-definition-correctness">Class definition correctness</h2>

<p>The check if a given class implement its interface&rsquo;s methods or not is checked at compile time, so no javascript involved.</p>

<h2 id="optimization">Optimization</h2>

<p>If it can proved which method will be call then the <code>object_method_call</code> become useless and the direct access to the function can be used, and this could be done a lot.</p>

<h1 id="exception-and-errors">Exception and errors</h1>

<div class="brush: php">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="cp">&lt;?php</span>

<span class="k">try</span> <span class="p">{}</span>
<span class="k">catch</span><span class="p">(</span><span class="nx">Abc</span> <span class="nv">$a</span><span class="p">)</span> <span class="p">{}</span>
<span class="k">catch</span><span class="p">(</span><span class="nx">Edf</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{}</span>
<span class="k">finally</span> <span class="p">{}</span>
</pre></div>
</td></tr></tbody></table>
</div>

<div class="brush: javascript">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4
5
6</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="k">try</span> <span class="p">{}</span>
<span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">e</span> <span class="k">instanceof</span> <span class="nx">PHPConstructor</span><span class="p">.</span><span class="nx">Abc</span><span class="p">)</span> <span class="p">{}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">e</span> <span class="k">instanceof</span> <span class="nx">PHPConstructor</span><span class="p">.</span><span class="nx">Edf</span><span class="p">)</span> <span class="p">{}</span>
  <span class="nx">finallyCode</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>For the <code>set_exception_handler</code> the complete generate code need to be wrapped inside a try that catch on PHP.Exception and apply handler if there is. By the way <code>exit()</code> and <code>die()</code> will be implemented respectively with <code>throw new PHP.Exit()</code> and <code>throw new PHP.Die()</code>.</p>

<p>For errors this is different because errors don&rsquo;t stop the execution of the code, i don&rsquo;t know all the cases where error happen but the only one i see demanding extra work is the access to an undefined variable.</p>

<div class="brush: php">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="x">echo $a;</span>
</pre></div>
</td></tr></tbody></table>
</div>

<div class="brush: javascript">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="c1">// keep in mind that like javascript php hoist its variables, so scan the code,</span>
<span class="c1">// find all variable, declare them all with UNASSIGNED</span>
<span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">PHP</span><span class="p">.</span><span class="nx">UNASSIGNED</span><span class="p">;</span>
<span class="nx">PHP</span><span class="p">.</span><span class="nx">echo</span><span class="p">((</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">===</span> <span class="nx">PHP</span><span class="p">.</span><span class="nx">UNASSIGNED</span><span class="p">)</span> <span class="p">{</span> <span class="nx">PHP</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="s1">&#39;undefined $a&#39;</span><span class="p">;</span> <span class="k">return</span> <span class="nx">PHP</span><span class="p">.</span><span class="kc">null</span><span class="p">;</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">a</span><span class="p">;}})());</span>
</pre></div>
</td></tr></tbody></table>
</div>

<h1 id="other-statements">Other statements</h1>

<h2 id="instanceof">Instanceof</h2>

<div class="brush: javascript">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="c1">// full qualified class name, namespace are a</span>
<span class="c1">// compile time thing in php</span>
<span class="nx">PHP</span><span class="p">.</span><span class="k">instanceof</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="kr">class</span><span class="p">)</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">fn</span><span class="p">;</span>
   <span class="nx">fn</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">meta</span><span class="p">)</span> <span class="p">{</span>
       <span class="k">if</span> <span class="p">(</span><span class="nx">meta</span> <span class="o">==</span> <span class="nx">PHPCLASS</span><span class="p">[</span><span class="kr">class</span><span class="p">])</span> <span class="p">{</span>
           <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
       <span class="p">}</span>
       <span class="k">if</span> <span class="p">(</span><span class="nx">meta</span><span class="p">.</span><span class="kr">extends</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
           <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
       <span class="p">}</span>
       <span class="k">return</span> <span class="nx">fn</span><span class="p">(</span><span class="nx">meta</span><span class="p">.</span><span class="kr">extends</span><span class="p">);</span>
   <span class="p">};</span>
   <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">PHP</span><span class="p">.</span><span class="nb">Object</span><span class="p">)</span> <span class="p">{</span>
       <span class="k">return</span> <span class="nx">fn</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">meta</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</td></tr></tbody></table>
</div>

<h2 id="if-and-while">If and while</h2>

<div class="brush: php">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="cp">&lt;?php</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$expr</span><span class="p">)</span> <span class="p">{}</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Transpile to:</p>

<div class="brush: javascript">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="k">if</span> <span class="p">(</span><span class="nx">PHP</span><span class="p">.</span><span class="nx">to_bool</span><span class="p">(</span><span class="nx">expr</span><span class="p">))</span> <span class="p">{}</span>
</pre></div>
</td></tr></tbody></table>
</div>

<h1 id="yield">Yield</h1>

<p>Assume a funcion like so:</p>

<div class="brush: php">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="cp">&lt;?php</span>

<span class="k">function</span> <span class="nf">fn</span><span class="p">()</span> <span class="p">{</span>
    <span class="nv">$a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nv">$a</span><span class="o">++</span><span class="p">;</span>
    <span class="k">yield</span> <span class="nv">$a</span><span class="p">;</span>
    <span class="nv">$a</span><span class="o">++</span><span class="p">;</span>
    <span class="k">yield</span> <span class="nv">$a</span><span class="p">;</span>
    <span class="nv">$a</span><span class="o">++</span><span class="p">;</span>
    <span class="k">yield</span> <span class="nv">$a</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>The yield can be seen as a function that return at yield, and when call later will not start from the begining of the function but from the last used yield. And also have the same state from last call.</p>

<div class="brush: javascript">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="nx">PHPFunction</span><span class="p">.</span><span class="nx">fn</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
<span class="k">return</span> <span class="k">new</span> <span class="nx">PHP</span><span class="p">.</span><span class="nx">Generator</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">a</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">codes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="c1">// all the code for remove complexity in code analysis</span>
            <span class="nx">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="nx">a</span><span class="o">++</span><span class="p">;</span>
            <span class="nx">position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">a</span><span class="p">;</span>
            <span class="nx">a</span><span class="o">++</span><span class="p">;</span>
            <span class="nx">position</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">a</span><span class="p">;</span>
            <span class="nx">a</span><span class="o">++</span><span class="p">;</span>
            <span class="nx">position</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">a</span><span class="p">;</span>
        <span class="p">},</span>
        <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="nx">a</span><span class="o">++</span><span class="p">;</span>
            <span class="nx">position</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">a</span><span class="p">;</span>
            <span class="nx">a</span><span class="o">++</span><span class="p">;</span>
            <span class="nx">position</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">a</span><span class="p">;</span>
        <span class="p">},</span>
        <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="nx">a</span><span class="o">++</span><span class="p">;</span>
            <span class="nx">position</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">a</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">];</span>
    <span class="kd">var</span> <span class="nx">end</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">end</span><span class="p">)</span> <span class="k">return</span> <span class="p">;</span>
        <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">codes</span><span class="p">[</span><span class="nx">position</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
        <span class="nx">end</span> <span class="o">=</span> <span class="p">(</span><span class="nx">codes</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nx">position</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">}();</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>But what happen when we put a yield inside a loop:</p>

<div class="brush: php">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="cp">&lt;?php</span>

<span class="k">function</span> <span class="nf">fn</span><span class="p">(</span><span class="nv">$datas</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">stuffA</span><span class="p">();</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$datas</span> <span class="k">as</span> <span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">stuffB</span><span class="p">();</span>
        <span class="k">yield</span> <span class="nv">$data</span><span class="p">;</span>
        <span class="nx">stuffC</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="nx">stuffD</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>This one is more hard, transform the foreach into a goto:</p>

<div class="brush: php">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="cp">&lt;?php</span>

<span class="k">function</span> <span class="nf">fn</span><span class="p">(</span><span class="nv">$datas</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">stuffA</span><span class="p">();</span>
    <span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">begin_loop</span><span class="o">:</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$datas</span><span class="p">[</span><span class="nv">$i</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nx">goto</span> <span class="nx">end_loop</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$datas</span><span class="p">[</span><span class="nv">$i</span><span class="p">];</span>
    <span class="nx">stuffB</span><span class="p">();</span>
    <span class="k">yield</span> <span class="nv">$data</span><span class="p">;</span>
    <span class="nx">stuffC</span><span class="p">();</span>
    <span class="nv">$i</span><span class="o">++</span><span class="p">;</span>
    <span class="nx">goto</span> <span class="nx">begin_loop</span><span class="p">;</span>
    <span class="nx">end_loop</span><span class="o">:</span>
    <span class="nx">stuffD</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>just convert the goto, but let the yield untreated.</p>

<div class="brush: javascript">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="nx">PHP</span><span class="p">.</span><span class="nx">Goto</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">PHPFunction</span><span class="p">.</span><span class="nx">fn</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">datas</span><span class="p">)</span> <span class="p">{</span>
<span class="k">return</span> <span class="k">new</span> <span class="nx">PHP</span><span class="p">.</span><span class="nx">Generator</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">that</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">data</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">gotos</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;begin_loop&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">PHP</span><span class="p">.</span><span class="nx">isset</span><span class="p">(</span><span class="nx">datas</span><span class="p">,</span> <span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">new</span> <span class="nx">PHP</span><span class="p">.</span><span class="nx">Goto</span><span class="p">(</span><span class="s1">&#39;end_loop&#39;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">data</span> <span class="o">=</span> <span class="nx">PHP</span><span class="p">.</span><span class="nx">array_access</span><span class="p">(</span><span class="nx">datas</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
            <span class="nx">PHPFunction</span><span class="p">.</span><span class="nx">stuffB</span><span class="p">();</span>
            <span class="k">yield</span> <span class="nx">$data</span><span class="p">;</span>
            <span class="nx">PHPFunction</span><span class="p">.</span><span class="nx">stuffC</span><span class="p">();</span>
            <span class="nx">i</span><span class="o">++</span><span class="p">;</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">PHP</span><span class="p">.</span><span class="nx">Goto</span><span class="p">(</span><span class="s1">&#39;begin_loop&#39;</span><span class="p">);</span>
            <span class="nx">PHPFunction</span><span class="p">.</span><span class="nx">stuffD</span><span class="p">();</span>
        <span class="p">},</span>
        <span class="s1">&#39;end_loop&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="nx">PHPFunction</span><span class="p">.</span><span class="nx">stuffD</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">};</span>


    <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">trampoline</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="nx">PHPFunction</span><span class="p">.</span><span class="nx">stuffA</span><span class="p">();</span>
            <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">PHP</span><span class="p">.</span><span class="nx">isset</span><span class="p">(</span><span class="nx">datas</span><span class="p">,</span> <span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">new</span> <span class="nx">PHP</span><span class="p">.</span><span class="nx">Goto</span><span class="p">(</span><span class="s1">&#39;end_loop&#39;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">data</span> <span class="o">=</span> <span class="nx">PHP</span><span class="p">.</span><span class="nx">array_access</span><span class="p">(</span><span class="nx">datas</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
            <span class="nx">PHPFunction</span><span class="p">.</span><span class="nx">stuffB</span><span class="p">();</span>
            <span class="k">yield</span> <span class="nx">$data</span><span class="p">;</span>
            <span class="nx">PHPFunction</span><span class="p">.</span><span class="nx">stuffC</span><span class="p">();</span>
            <span class="nx">i</span><span class="o">++</span><span class="p">;</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">PHP</span><span class="p">.</span><span class="nx">Goto</span><span class="p">(</span><span class="s1">&#39;begin_loop&#39;</span><span class="p">);</span>
            <span class="nx">PHPFunction</span><span class="p">.</span><span class="nx">stuffD</span><span class="p">();</span>
        <span class="p">};</span>

        <span class="kd">var</span> <span class="nx">go</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="nx">trampoline</span> <span class="o">=</span> <span class="nx">trampoline</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">that</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">trampoline</span> <span class="k">instanceof</span> <span class="nx">PHP</span><span class="p">.</span><span class="nx">Goto</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">trampoline</span> <span class="o">=</span> <span class="nx">gotos</span><span class="p">[</span><span class="nx">trampoline</span><span class="p">.</span><span class="nx">name</span><span class="p">];</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">go</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nx">go</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">trampoline</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">})();</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Without the yield:</p>

<div class="brush: javascript">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="nx">PHP</span><span class="p">.</span><span class="nx">Goto</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">PHPFunction</span><span class="p">.</span><span class="nx">fn</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">datas</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">PHP</span><span class="p">.</span><span class="nx">Generator</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">that</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">data</span><span class="p">;</span>

        <span class="kd">var</span> <span class="nx">gotos</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;begin_loop&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">PHP</span><span class="p">.</span><span class="nx">isset</span><span class="p">(</span><span class="nx">datas</span><span class="p">,</span> <span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="k">new</span> <span class="nx">PHP</span><span class="p">.</span><span class="nx">Goto</span><span class="p">(</span><span class="s1">&#39;end_loop&#39;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="nx">data</span> <span class="o">=</span> <span class="nx">PHP</span><span class="p">.</span><span class="nx">array_access</span><span class="p">(</span><span class="nx">datas</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
                <span class="nx">PHPFunction</span><span class="p">.</span><span class="nx">stuffB</span><span class="p">();</span>
                <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
                <span class="nx">PHPFunction</span><span class="p">.</span><span class="nx">stuffC</span><span class="p">();</span>
                <span class="nx">i</span><span class="o">++</span><span class="p">;</span>
                <span class="k">return</span> <span class="k">new</span> <span class="nx">PHP</span><span class="p">.</span><span class="nx">Goto</span><span class="p">(</span><span class="s1">&#39;begin_loop&#39;</span><span class="p">);</span>
                <span class="nx">PHPFunction</span><span class="p">.</span><span class="nx">stuffD</span><span class="p">();</span>
            <span class="p">},</span>
            <span class="s1">&#39;end_loop&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">PHPFunction</span><span class="p">.</span><span class="nx">stuffD</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">};</span>

        <span class="kd">var</span> <span class="nx">codes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">PHPFunction</span><span class="p">.</span><span class="nx">stuffA</span><span class="p">();</span>
                <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">PHP</span><span class="p">.</span><span class="nx">isset</span><span class="p">(</span><span class="nx">datas</span><span class="p">,</span> <span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="k">new</span> <span class="nx">PHP</span><span class="p">.</span><span class="nx">Goto</span><span class="p">(</span><span class="s1">&#39;end_loop&#39;</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="nx">data</span> <span class="o">=</span> <span class="nx">PHP</span><span class="p">.</span><span class="nx">array_access</span><span class="p">(</span><span class="nx">datas</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
                <span class="nx">PHPFunction</span><span class="p">.</span><span class="nx">stuffB</span><span class="p">();</span>
                <span class="nx">position</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="k">return</span> <span class="k">new</span> <span class="nx">data</span><span class="p">;</span>
                <span class="nx">PHPFunction</span><span class="p">.</span><span class="nx">stuffC</span><span class="p">();</span>
                <span class="nx">i</span><span class="o">++</span><span class="p">;</span>
                <span class="k">return</span> <span class="k">new</span> <span class="nx">PHP</span><span class="p">.</span><span class="nx">Goto</span><span class="p">(</span><span class="s1">&#39;begin_loop&#39;</span><span class="p">);</span>
                <span class="nx">PHPFunction</span><span class="p">.</span><span class="nx">stuffD</span><span class="p">();</span>
            <span class="p">},</span>
            <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">PHPFunction</span><span class="p">.</span><span class="nx">stuffC</span><span class="p">();</span>
                <span class="nx">i</span><span class="o">++</span><span class="p">;</span>
                <span class="k">return</span> <span class="k">new</span> <span class="nx">PHP</span><span class="p">.</span><span class="nx">Goto</span><span class="p">(</span><span class="s1">&#39;begin_loop&#39;</span><span class="p">);</span>
                <span class="nx">PHPFunction</span><span class="p">.</span><span class="nx">stuffD</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">];</span>

        <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">trampoline</span> <span class="o">=</span> <span class="nx">codes</span><span class="p">[</span><span class="nx">position</span><span class="p">];</span>

            <span class="kd">var</span> <span class="nx">go</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="k">do</span> <span class="p">{</span>
                <span class="nx">trampoline</span> <span class="o">=</span> <span class="nx">trampoline</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">that</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">trampoline</span> <span class="k">instanceof</span> <span class="nx">PHP</span><span class="p">.</span><span class="nx">Goto</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">trampoline</span> <span class="o">=</span> <span class="nx">gotos</span><span class="p">[</span><span class="nx">trampoline</span><span class="p">.</span><span class="nx">name</span><span class="p">];</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">go</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nx">go</span><span class="p">);</span>

            <span class="k">return</span> <span class="nx">trampoline</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">});</span>
<span class="p">};</span>
</pre></div>
</td></tr></tbody></table>
</div>

<h1 id="passing-arguments-by-address">Passing arguments by address</h1>

<p>Wrap every arguments inside a Box for every call you can&rsquo;t infer the signature of the function.</p>

<div class="brush: php">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="cp">&lt;?php</span>

<span class="nv">$a</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="nb">end</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
</pre></div>
</td></tr></tbody></table>
</div>

<div class="brush: javascript">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="kd">var</span> <span class="nx">PHP</span><span class="p">.</span><span class="nx">Box</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</td></tr></tbody></table>
</div>

<div class="brush: javascript">
 <table class="sourcetable">
  <tbody>
   <tr>
    <td class="linenos">
     <div class="linenodiv">
      <pre>1
2
3
4</pre></div></td>
    <td class="code">
     <div class="source">
      <pre><span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">PHP</span><span class="p">.</span><span class="nx">array</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">a_box</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PHP</span><span class="p">.</span><span class="nx">Box</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
<span class="nx">PHPFunction</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">a_box</span><span class="p">);</span>
<span class="nx">a</span> <span class="o">=</span> <span class="nx">a_box</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
</pre></div>
</td></tr></tbody></table>
</div>

<p>Heavy.</p>

<h2 id="unset">Unset</h2>

<p>Easy PHP.UNASSIGNED is for.</p>

<h1 id="dont-took-into-account">Don&rsquo;t took into account</h1>

<ol>
 <li>Foreach</li>
 <li>Break and continue</li>
 <li>Anonymous Class</li>
 <li>Autoload</li>
 <li>Tick</li>
 <li>Object reflection</li>
 <li>Closure syntax</li>
 <li>Resources</li>
 <li>Trait (but a pure compile time mechanic)</li>
 <li>Namespace (also a pure compile time mechanic)</li></ol>

<p>And more.</p>

<h1 id="conclusion">Conclusion</h1>

<p>It&rsquo;s more complex than i would have thought in the first place. Minification seems to be feasible only on white space and on few PHP.{} name definition. The dead code elimination is impossible if the used function can&rsquo;t be infered from a static analysis (use call_user_function or <code>$this-&gt;{$expr}()</code> will forbid optimization) of the code is used, that will lead to heavy weight file. The constant need to convert thing in and out could also greatly decrease the performances and can&rsquo;t be easily optimized like method calls.</p>
   </div>
   <footer>
  </footer>
</article>
        </div>
      </div>
      <footer>
        <hr/>
        <p>Site generated
        by <a href="https://github.com/greghendershott/frog">Frog</a>,
        the <strong>fr</strong>ozen bl<strong>og</strong> tool.</p>
        <p>Using <a href="http://twitter.github.com/bootstrap/index.html">Bootstrap</a>.</p>
      </footer>
    </div>
    <!-- </body> JS -->
    <!-- <script type="text/javascript" src="//code.jquery.com/jquery.min.js"></script> -->
    <!-- <script type="text/javascript" src="/js/bootstrap.min.js"></script> -->
  </body>
</html>